<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="../reset.css" />
		<link rel="shortcut icon" href="data:" />
		<title>Tests</title>
		<script type="module">
			import { h } from './_lib.js'
			const search = new URLSearchParams(location.search)
			const filter = search.get('filter')
			if (filter) document.querySelector('input[name=filter]').value = filter
			globalThis.DHTML_PROD = search.has('prod')

			let running = 0
			let passed = 0
			let failed = 0
			let total = 0
			function updateTitle() {
				document.title = `${passed + failed}/${total} üü°${running} ‚úÖ${passed} ‚ùå${failed}`
			}

			customElements.define(
				'a-test',
				class extends HTMLElement {
					constructor() {
						super()
						total++
						updateTitle()
					}
					get src() {
						return this.getAttribute('src')
					}
					connectedCallback() {
						if (filter && !this.src.includes(filter)) {
							this.remove()
							return
						}

						this.append(
							h(
								'details',
								{ open: filter !== null },
								(this.summary = h(
									'summary',
									{},
									(this.icon = document.createTextNode('üîç')),
									document.createTextNode(this.src),
								)),
								h('p', {}, h('a', { href: this.src, target: '_blank' }, 'üîó source')),
								h('pre', {}, (this.status = document.createTextNode('waiting...'))),
								(this.container = h('div', {}, '')),
							),
						)

						// requestIdleCallback isn't supported in safari???
						;(globalThis.requestIdleCallback ?? globalThis.setTimeout)(async () => {
							running++
							this.icon.data = 'üü°'
							this.status.data = 'running...'
							this.summary.style.backgroundColor = 'rgba(255, 255, 128, 0.5)'
							updateTitle()

							const root = this.container.attachShadow({ mode: 'open' })
							try {
								const module = await import(this.src)
								await module.default(root)
								this.pass()
							} catch (error) {
								this.fail(error)
							} finally {
								running--
								updateTitle()
							}
						})
					}

					pass() {
						passed++
						console.log('‚úÖ', this.src)
						this.icon.data = '‚úÖ'
						this.status.data = ''
						this.summary.style.backgroundColor = 'rgba(128, 255, 128, 0.5)'
					}
					fail(error) {
						failed++
						console.error('‚ùå', this.src, error)
						this.icon.data = '‚ùå'
						this.status.data = `${error}`
						this.summary.style.backgroundColor = 'rgba(255, 128, 128, 0.5)'
					}
				},
			)
		</script>
		<style>
			form {
				display: flex;
				input {
					flex: 1;
				}
			}
			summary {
				padding: 0.2rem;
			}
		</style>
	</head>
		<form>
			<input type="text" name="filter" />
			<button type="submit">üîç</button>
		</form>
		<a-test src="./attributes.js"></a-test>
		<a-test src="./basic.js"></a-test>
		<a-test src="./basic-child.js"></a-test>
		<a-test src="./custom-element-compat.js"></a-test>
		<a-test src="./custom-part-class.js"></a-test>
		<a-test src="./custom-part-class-with-value.js"></a-test>
		<a-test src="./custom-part-function.js"></a-test>
		<a-test src="./custom-part-function-with-value.js"></a-test>
		<a-test src="./embed-nodes.js"></a-test>
		<a-test src="./lists.js"></a-test>
		<a-test src="./no-clobber.js"></a-test>
		<a-test src="./recursive.js"></a-test>
		<a-test src="./renderable.js"></a-test>
		<a-test src="./renderable-throws.js"></a-test>
		<a-test src="./renderable-unmount-deep.js"></a-test>
		<a-test src="./renderable-unmount-shallow.js"></a-test>
		<a-test src="./update-identity.js"></a-test>
		<a-test src="./user-errors.js"></a-test>
	</body>
</html>
