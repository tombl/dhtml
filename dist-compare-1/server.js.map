{"version":3,"file":"server.js","names":["statics: TemplateStringsArray","compiled: CompiledTemplate","prev_state: lexer.State | undefined","attr_name: string","attr_start: number | undefined","value: unknown","name: string","str: unknown","value: Displayable","value"],"sources":["../src/server.ts"],"sourcesContent":["import { assert, is_html, is_iterable, is_renderable, lexer, single_part_template, type Displayable } from './shared.ts'\n\ninterface PartRenderer {\n\treplace_start: number\n\treplace_end: number\n\trender: (values: unknown[]) => string | Generator<string, void, void>\n}\n\ninterface CompiledTemplate {\n\tsource: string\n\tparts: PartRenderer[]\n\textra_parts: number\n}\n\nconst WHITESPACE = /\\s/\n\nconst templates = new WeakMap<TemplateStringsArray, CompiledTemplate>()\nfunction compile_template(statics: TemplateStringsArray): CompiledTemplate {\n\tconst cached = templates.get(statics)\n\tif (cached) return cached\n\n\tconst compiled: CompiledTemplate = {\n\t\tsource: statics.join('\\0'),\n\t\tparts: [],\n\t\textra_parts: 0,\n\t}\n\tlet offset = 0\n\tlet dyn_i = 0\n\n\tlet whitespace_count = 0\n\tlet prev_state: lexer.State | undefined\n\tlet attr_name: string = ''\n\tlet attr_start: number | undefined\n\n\tfunction collapse_whitespace() {\n\t\tif (whitespace_count > 1) {\n\t\t\tcompiled.extra_parts++\n\t\t\tcompiled.parts.push({\n\t\t\t\treplace_start: offset - whitespace_count,\n\t\t\t\treplace_end: offset,\n\t\t\t\trender: () => ' ',\n\t\t\t})\n\t\t}\n\t\twhitespace_count = 0\n\t}\n\n\tfor (const [char, state] of lexer.lex(statics)) {\n\t\tif (state === lexer.ATTR_NAME) {\n\t\t\tif (prev_state !== lexer.ATTR_NAME) {\n\t\t\t\tattr_name = ''\n\t\t\t\tattr_start = offset\n\t\t\t}\n\t\t\tattr_name += char\n\t\t}\n\n\t\tif (state === lexer.DATA && WHITESPACE.test(char)) {\n\t\t\twhitespace_count++\n\t\t} else {\n\t\t\tcollapse_whitespace()\n\t\t}\n\n\t\tif (char === '\\0') {\n\t\t\tconst i = dyn_i++\n\n\t\t\tswitch (state) {\n\t\t\t\tcase lexer.DATA:\n\t\t\t\tcase lexer.COMMENT:\n\t\t\t\tcase lexer.COMMENT2:\n\t\t\t\t\tcompiled.parts.push({\n\t\t\t\t\t\treplace_start: offset,\n\t\t\t\t\t\treplace_end: offset + 1,\n\t\t\t\t\t\trender: values => render_child(values[i]),\n\t\t\t\t\t})\n\t\t\t\t\tbreak\n\n\t\t\t\tcase lexer.ATTR_VALUE_UNQUOTED:\n\t\t\t\tcase lexer.ATTR_VALUE_DOUBLE_QUOTED:\n\t\t\t\tcase lexer.ATTR_VALUE_SINGLE_QUOTED:\n\t\t\t\t\tconst name = attr_name\n\t\t\t\t\tassert(attr_start !== undefined)\n\t\t\t\t\tcompiled.parts.push({\n\t\t\t\t\t\treplace_start: attr_start,\n\t\t\t\t\t\treplace_end: offset + 1 + (state === lexer.ATTR_VALUE_UNQUOTED ? 0 : 1),\n\t\t\t\t\t\trender: values => render_attribute(name, values[i]),\n\t\t\t\t\t})\n\t\t\t\t\tbreak\n\n\t\t\t\tcase lexer.ATTR_NAME:\n\t\t\t\t\tcompiled.parts.push({\n\t\t\t\t\t\treplace_start: offset,\n\t\t\t\t\t\treplace_end: offset + 1,\n\t\t\t\t\t\trender: values => render_directive(values[i]),\n\t\t\t\t\t})\n\t\t\t\t\tbreak\n\n\t\t\t\tdefault:\n\t\t\t\t\tassert(false, `unexpected state ${state}`)\n\t\t\t}\n\t\t}\n\n\t\tprev_state = state\n\t\toffset++\n\t}\n\tcollapse_whitespace()\n\n\tif (__DEV__) {\n\t\tlet prev_end = -1\n\t\tfor (const { replace_start, replace_end } of compiled.parts) {\n\t\t\tassert(replace_start >= prev_end)\n\t\t\tassert(replace_start < replace_end)\n\t\t\tprev_end = replace_end\n\t\t}\n\t}\n\n\ttemplates.set(statics, compiled)\n\treturn compiled\n}\n\nfunction render_directive(value: unknown) {\n\tif (value === null) return ''\n\n\tassert(typeof value === 'function')\n\t// console.log('directive returned:', value())\n\n\treturn ''\n}\n\nfunction render_attribute(name: string, value: unknown) {\n\tif (value === false || value === null || typeof value === 'function') {\n\t\treturn ''\n\t}\n\tif (value === true) return name\n\treturn `${name}=\"${escape(value)}\"`\n}\n\nfunction* render_child(value: unknown): Generator<string, void, void> {\n\tyield '<?[>'\n\n\tif (is_renderable(value)) {\n\t\ttry {\n\t\t\tvalue = value.render()\n\t\t} catch (thrown) {\n\t\t\tif (is_html(thrown)) {\n\t\t\t\tvalue = thrown\n\t\t\t} else {\n\t\t\t\tthrow thrown\n\t\t\t}\n\t\t}\n\n\t\tif (is_renderable(value)) value = single_part_template(value)\n\t}\n\n\tif (is_iterable(value)) {\n\t\tfor (const item of value) yield* render_child(item)\n\t} else if (is_html(value)) {\n\t\tconst { _statics: statics, _dynamics: dynamics } = value\n\t\tconst template = compile_template(statics)\n\n\t\tassert(\n\t\t\ttemplate.parts.length - template.extra_parts === dynamics.length,\n\t\t\t'expected the same number of dynamics as parts. do you have a ${...} in an unsupported place?',\n\t\t)\n\n\t\tlet prev_end = 0\n\t\tfor (const { replace_start, replace_end, render } of template.parts) {\n\t\t\tyield template.source.slice(prev_end, replace_start)\n\t\t\tyield* render(dynamics)\n\t\t\tprev_end = replace_end\n\t\t}\n\t\tyield template.source.slice(prev_end)\n\t} else if (value !== null) {\n\t\tyield escape(value)\n\t}\n\n\tyield '<?]>'\n}\n\nconst ESCAPE_RE = /[&<>\"']/g\nconst ESCAPE_SUBSTITUTIONS = {\n\t'&': '&amp;',\n\t'<': '&lt;',\n\t'>': '&gt;',\n\t'\"': '&quot;',\n\t\"'\": '&#39;',\n}\nfunction escape(str: unknown) {\n\treturn String(str).replace(ESCAPE_RE, c => ESCAPE_SUBSTITUTIONS[c as keyof typeof ESCAPE_SUBSTITUTIONS])\n}\n\nexport function renderToString(value: Displayable): string {\n\tlet str = ''\n\tfor (const part of render_child(value)) str += part\n\treturn str\n}\n\nexport function renderToReadableStream(value: Displayable): ReadableStream<Uint8Array> {\n\tconst iter = render_child(value)\n\treturn new ReadableStream<string>({\n\t\tpull(controller) {\n\t\t\tconst { done, value } = iter.next()\n\t\t\tif (done) {\n\t\t\t\tcontroller.close()\n\t\t\t\treturn\n\t\t\t}\n\t\t\tcontroller.enqueue(value)\n\t\t},\n\t}).pipeThrough(new TextEncoderStream())\n}\n"],"mappings":"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"}